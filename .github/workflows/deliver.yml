name: Deliver to Public Repository

on:
  push:
    tags: ['v*']

permissions:
  contents: read

jobs:
  deliver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Remove private files
        run: |
          # Internal review reports
          rm -rf reports/

          # Internal team documents
          rm -f docs/TEAM-ONBOARDING.md
          rm -f .github/BRANCH_PROTECTION.md

          # Internal roadmap
          rm -f TODO.md

          # Private repo CI workflows
          rm -f .github/workflows/changelog-update.yml
          rm -f .github/workflows/release.yml
          rm -f .github/workflows/deliver.yml

          # Private repo CI scripts
          rm -f scripts/update-changelog.js

          # Clean empty directories
          find . -type d -empty -delete 2>/dev/null || true

      - name: Replace repository URLs
        run: |
          # Replace all references to private repo with public repo
          find . -type f \( -name "*.md" -o -name "*.json" -o -name "*.sh" \) -exec \
            sed -i 's|lemon-etvibe/etvibe-nextjs-fullstack|lemon-etvibe/claude-nextjs-fullstack|g' {} +
          find . -type f -name "*.sh" -exec \
            sed -i 's|etvibe-nextjs-fullstack|claude-nextjs-fullstack|g' {} +

      - name: Remove PR numbers from CHANGELOG
        run: |
          # Remove private repo PR references (e.g., "(#15)" â†’ "")
          sed -i 's/ (#[0-9]\+)//g' CHANGELOG.md

      - name: Push to public repository
        env:
          DEPLOY_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage all remaining files
          git add -A
          git commit -m "release: ${VERSION}" --allow-empty

          # Push to public repo (force to keep clean history)
          git remote add public "https://x-access-token:${DEPLOY_TOKEN}@github.com/lemon-etvibe/claude-nextjs-fullstack.git"
          git push public HEAD:main --force

          # Create matching tag on public repo (delete existing if re-releasing)
          git push public ":refs/tags/${VERSION}" 2>/dev/null || true
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          git push public "${VERSION}"

      - name: Create GitHub Release on public repo
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"

          # Extract release notes from CHANGELOG
          NOTES=$(sed -n "/## \[${VERSION#v}\]/,/## \[/p" CHANGELOG.md | head -n -1)

          gh release create "${VERSION}" \
            --repo lemon-etvibe/claude-nextjs-fullstack \
            --title "Release ${VERSION}" \
            --notes "${NOTES}" \
            2>/dev/null || echo "Release creation skipped (may already exist)"
